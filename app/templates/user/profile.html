{% extends 'base.html' %}
{% block title %}{{ user.full_name }}'s Profile{% endblock %}

{% block head %}
{{ super() }}
<style>
    /* Add some styling for the new profile image */
    .profile-avatar-img {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid #fff;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .profile-header {
        display: flex;
        align-items: center;
        margin-bottom: 2rem;
    }
    .profile-info {
        margin-left: 1.5rem;
    }
    .profile-actions {
        margin-left: auto;
    }
</style>
{% endblock %}


{% block content %}
<div class="container py-4">

    <div class="profile-header col-lg-10">
        <!-- MODIFIED: Display profile image -->
        <div class="col-lg-2">
            {# Check if the user object has a valid profile image path #}
            {% if user.profile_image_file and user.profile_image_file|length > 25 %}
                <img class="img-fluid rounded-circle border shadow" 
                    src="{{ storage_service.get_file_url(user.profile_image_file) }}" 
                    alt="Profile Picture"
                    style="width: 120px; height: 120px; object-fit: cover;"
                    onerror="this.style.display='none'; document.getElementById('profile-initials-{{ user.id }}').style.display='flex';">
                
                {# Hidden initials as a backup for broken links #}
                <div id="profile-initials-{{ user.id }}" class="justify-content-center align-items-center rounded-circle border shadow"
                    style="width: 120px; height: 120px; background-color: #007bff; color: #fff; font-weight: bold; font-size: 40px; display: none;">
                    {{ user.first_name[0]|upper }}{{ user.last_name[0]|upper }}
                </div>
            {% else %}
                <div class="profile-initials-container d-flex justify-content-center align-items-center"
                    style="width: 120px; height: 120px; background-color: #007bff; border-radius: 50%; color: #fff; font-weight: bold; font-size: 40px;">
                    {{ user.first_name[0]|upper }}{{ user.last_name[0]|upper }}
                </div>
            {% endif %}
        </div>

        <div class="profile-info">
            <h2 class="profile-name">{{ user.full_name }}</h2>
            <p class="profile-role">{{ user.role.capitalize() }}</p>
        </div>

    </br>
        
        <!-- ADDED: Edit Profile Button -->
         {% if current_user.role|lower in ['admin', 'supervisor', 'director'] %}
        <div class="profile-actions">
            <a href="{{ url_for('user.edit_user', user_id=user.id) }}" class="btn btn-outline-primary">
                <i class="fas fa-edit me-1"></i>Edit Profile
            </a>
        </div>
        {% endif %}
    </div>

    <!-- The rest of your profile.html content remains the same -->
    <div class="row">
        <div class="col-lg-4">
            <div class="widget-card">
                <div class="widget-header"><h5><i class="fas fa-user-circle me-2"></i>User Details</h5></div>
                <div class="widget-body">
                    <ul class="details-list">
                        <li><i class="fas fa-envelope"></i> <strong>Email:</strong>&nbsp; {{ user.email }}</li>
                        <li><i class="fas fa-phone"></i> <strong>Phone:</strong>&nbsp; {{ user.phone_number }}</li>
                        <li><i class="fas fa-building"></i> <strong>Department:</strong>&nbsp; {{ user.department.name }}</li>
                        <li><i class="fas fa-user-shield"></i> <strong>Supervisor:</strong>&nbsp;
                            {% if supervisor %}{{ supervisor.full_name }}{% else %}N/A{% endif %}
                        </li>
                    </ul>
                </div>
            </div>

            <div class="widget-card">
                <div class="widget-header"><h5><i class="fas fa-users me-2"></i>Colleagues</h5></div>
                <div class="widget-body p-0">
                    <div class="list-group list-group-flush">
                        {% for member in department_members %}
                            <a href="#" class="list-group-item list-group-item-action" data-bs-toggle="modal"
                               data-bs-target="#profileModal" data-user-id="{{ member.id }}">
                                {{ member.full_name }}
                            </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="widget-card">
                <div class="widget-header"><h5><i class="fas fa-chart-pie me-2"></i>Task Summary</h5></div>
                <div class="widget-body">
                    <div class="row g-3">
                        <div class="col-md-3 col-6"><div class="profile-stat-card"><p class="stat-value">{{ total_tasks }}</p><p class="stat-label">Total</p></div></div>
                        <div class="col-md-3 col-6"><div class="profile-stat-card"><p class="stat-value">{{ overdue_unstarted | length }}</p><p class="stat-label">Overdue</p></div></div>
                        <div class="col-md-3 col-6"><div class="profile-stat-card"><p class="stat-value">{{ in_progress | length }}</p><p class="stat-label">In Progress</p></div></div>
                        <div class="col-md-3 col-6"><div class="profile-stat-card"><p class="stat-value">{{ completed_tasks | length }}</p><p class="stat-label">Completed</p></div></div>
                    </div>
                </div>
            </div>
            
            <div class="widget-card">
                <div class="widget-header"><h5><i class="fas fa-chart-line me-2"></i>Performance Trends</h5></div>
                <div class="widget-body">
                    <h6>Average Task Completion Over Time</h6>
                    <canvas id="completionTimeChart" height="120"></canvas>
                    {% if most_common_task %}
                        <h6 class="mt-4">Trend for: {{ most_common_task }}</h6>
                        <canvas id="trendChart" height="120"></canvas>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-12">
            <div class="widget-card">
                <div class="widget-header"><h5><i class="fas fa-calendar-alt me-2"></i>Task Calendar</h5></div>
                <div class="widget-body">
                    <div id="calendar"></div>
                </div>
            </div>
        </div>
    </div>

        <div class="card shadow rounded-3 p-4 mt-4">
                        <!-- Clients Worked For (made collapsible) -->
            <div class="mb-4">
                <div class="card-header bg-light d-flex justify-content-between align-items-center cursor-pointer" 
                     data-bs-toggle="collapse" data-bs-target="#clientsWorkedForCollapse" aria-expanded="false" aria-controls="clientsWorkedForCollapse">
                    <h3 class="h5 fw-semibold text-dark mb-0">Clients You Worked For</h3>
                    <i class="fas fa-chevron-down ms-2"></i>
                </div>
                <div class="collapse" id="clientsWorkedForCollapse">
                    <div class="card-body">
                        {% if clients_worked_for %}
                            <div class="table-responsive">
                                <table class="table table-striped table-bordered rounded-3 overflow-hidden shadow-sm">
                                    <thead class="table-light">
                                        <tr>
                                            <th scope="col">Client Name</th>
                                            <th scope="col">Tasks Done</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for client_name, tasks in clients_worked_for.items() %}
                                            <tr>
                                                <td class="fw-medium text-dark">{{ client_name }}</td>
                                                <td>
                                                    <ul class="list-unstyled mb-0">
                                                        {% for task in tasks %}
                                                            <li><i class="fas fa-check-circle text-success me-2"></i>{{ task.title }}</li>
                                                        {% endfor %}
                                                    </ul>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <p class="text-muted">No client-related completed tasks found.</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Most Frequent Tasks (made collapsible) -->
            <div class="mb-4">
                <div class="card-header bg-light d-flex justify-content-between align-items-center cursor-pointer" 
                     data-bs-toggle="collapse" data-bs-target="#mostFrequentTasksCollapse" aria-expanded="false" aria-controls="mostFrequentTasksCollapse">
                    <h3 class="h5 fw-semibold text-dark mb-0">Your Most Frequent Tasks</h3>
                    <i class="fas fa-chevron-down ms-2"></i>
                </div>
                <div class="collapse" id="mostFrequentTasksCollapse">
                    <div class="card-body">
                        {% if most_frequent_tasks %}
                            <ul class="list-group">
                                {% for task_title, count in most_frequent_tasks %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span class="fw-medium text-dark">{{ task_title }}</span>
                                        <span class="badge bg-secondary">{{ count }} time(s)</span>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p class="text-muted">No tasks assigned to you to analyze frequency.</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Most Frequent Services (made collapsible) -->
            <div class="mb-4">
                <div class="card-header bg-light d-flex justify-content-between align-items-center cursor-pointer" 
                     data-bs-toggle="collapse" data-bs-target="#mostFrequentServicesCollapse" aria-expanded="false" aria-controls="mostFrequentServicesCollapse">
                    <h3 class="h5 fw-semibold text-dark mb-0">Your Most Frequent Services</h3>
                    <i class="fas fa-chevron-down ms-2"></i>
                </div>
                <div class="collapse" id="mostFrequentServicesCollapse">
                    <div class="card-body">
                        {% if most_frequent_services %}
                            <ul class="list-group">
                                {% for service_name, count in most_frequent_services %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span class="fw-medium text-dark">{{ service_name }}</span>
                                        <span class="badge bg-secondary">{{ count }} time(s)</span>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p class="text-muted">No service-related tasks assigned to you to analyze frequency.</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Most Frequent Templates (made collapsible) -->
            <div>
                <div class="card-header bg-light d-flex justify-content-between align-items-center cursor-pointer" 
                     data-bs-toggle="collapse" data-bs-target="#mostFrequentTemplatesCollapse" aria-expanded="false" aria-controls="mostFrequentTemplatesCollapse">
                    <h3 class="h5 fw-semibold text-dark mb-0">Your Most Frequent Task Templates</h3>
                    <i class="fas fa-chevron-down ms-2"></i>
                </div>
                <div class="collapse" id="mostFrequentTemplatesCollapse">
                    <div class="card-body">
                        {% if most_frequent_templates %}
                            <ul class="list-group">
                                {% for template_title, count in most_frequent_templates %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span class="fw-medium text-dark">{{ template_title }}</span>
                                        <span class="badge bg-secondary">{{ count }} time(s)</span>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p class="text-muted">No template-related tasks assigned to you to analyze frequency.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

</div>

<div class="modal fade" id="profileModal" tabindex="-1" aria-hidden="true"> ... </div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{# ... FullCalendar links ... #}


<script>

  const graphData = {{ graph_data | tojson }};

  const trendData = {{ most_common_trend | tojson }};

 

  const ctx = document.getElementById('completionTimeChart').getContext('2d');

  const trendCtx = document.getElementById('trendChart')?.getContext('2d');



  const labels = graphData.map(item => item.end_time);

  const durations = graphData.map(item => item.duration_minutes);

  const taskTitles = graphData.map(item => item.task_title);



  new Chart(ctx, {

    type: 'line',

    data: {

      labels: labels,

      datasets: [{

        label: 'Avg Completion Time (mins)',

        data: durations,

        borderColor: 'rgba(75, 192, 192, 1)',

        backgroundColor: 'rgba(75, 192, 192, 0.2)',

        tension: 0.3,

        fill: true

      }]

    },

    options: {

      responsive: true,

      plugins: {

        tooltip: {

          callbacks: {

            title: (items) => taskTitles[items[0].dataIndex],

            label: (item) => `Duration: ${item.formattedValue} mins`

          }

        }

      },

      scales: {

        y: {

          beginAtZero: true,

          title: { display: true, text: 'Minutes' }

        },

        x: {

          title: { display: true, text: 'Task Completion Date' }

        }

      }

    }

  });



  if (trendCtx) {

    const trendLabels = trendData.map(item => item.end_time);

    const trendDurations = trendData.map(item => item.duration_minutes);



    new Chart(trendCtx, {

      type: 'line',

      data: {

        labels: trendLabels,

        datasets: [{

          label: '{{ most_common_task }} Completion Trend',

          data: trendDurations,

          borderColor: 'rgba(153, 102, 255, 1)',

          backgroundColor: 'rgba(153, 102, 255, 0.2)',

          tension: 0.3,

          fill: true

        }]

      },

      options: {

        responsive: true,

        scales: {

          y: {

            beginAtZero: true,

            title: { display: true, text: 'Minutes' }

          },

          x: {

            title: { display: true, text: 'Date' }

          }

        }

      }

    });

  }



  // Load modal content on trigger

  const modal = document.getElementById("profileModal");

  modal.addEventListener("show.bs.modal", event => {

    const trigger = event.relatedTarget;

    const userId = trigger.getAttribute("data-user-id");

    fetch(`/users/${userId}/profile`)

      .then(res => res.text())

      .then(html => {

        document.getElementById("profile-modal-content").innerHTML = html;

      });

  });

</script>

<script>

  document.addEventListener('DOMContentLoaded', function () {

    const calendarEl = document.getElementById('calendar');

    const calendar = new FullCalendar.Calendar(calendarEl, {

      initialView: 'dayGridMonth',

      height: 'auto',

      events: {{ task_events | tojson }},

      headerToolbar: {

        left: 'prev,next today',

        center: 'title',

        right: 'dayGridMonth,listWeek'

      },

      eventClick: function(info) {

        if (info.event.url) {

          window.open(info.event.url, '_blank');

          info.jsEvent.preventDefault();

        }

      }

    });

    calendar.render();

  });

</script>

<script>
    // --- BRANDED CHARTS ---
    const graphData = {{ graph_data | tojson }};
    const trendData = {{ most_common_trend | tojson }};
    
    const ctx = document.getElementById('completionTimeChart').getContext('2d');
    const trendCtx = document.getElementById('trendChart')?.getContext('2d');

    // Chart 1: Avg Completion Time
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: graphData.map(item => item.end_time),
            datasets: [{
                label: 'Avg Completion Time (mins)',
                data: graphData.map(item => item.duration_minutes),
                // --- BRANDING UPDATE ---
                borderColor: '#ad2831', /* Our primary maroon */
                backgroundColor: 'rgba(173, 40, 49, 0.2)', /* Transparent maroon */
                tension: 0.3,
                fill: true
            }]
        },
        // ... options from your original code are fine ...
    });

    // Chart 2: Most Common Task Trend
    if (trendCtx) {
        new Chart(trendCtx, {
            type: 'line',
            data: {
                labels: trendData.map(item => item.end_time),
                datasets: [{
                    label: '{{ most_common_task }} Completion Trend',
                    data: trendData.map(item => item.duration_minutes),
                    // --- BRANDING UPDATE ---
                    borderColor: '#495057', /* A neutral dark gray */
                    backgroundColor: 'rgba(73, 80, 87, 0.2)',
                    tension: 0.3,
                    fill: true
                }]
            },
            // ... options from your original code are fine ...
        });
    }

    // Modal fetch logic remains the same
    // ...
</script>

{% endblock %}

