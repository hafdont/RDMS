<div class="table-responsive">
  <table class="table table-striped border shadow-sm">
    <thead>
      <tr>
        <th>Title</th>
        <th>Status</th>
        <th>Deadline</th>
        <th>Created By</th>
        <th>Client / Job</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% set tasks = pagination.items %}
      {% for task in tasks %}
      <tr class="{% if task.deadline and task.deadline < now %}table-danger{% elif task.deadline and task.deadline < now + timedelta(days=2) %}table-warning{% endif %}">
        <td><a href="{{ url_for('task.get_task', task_id=task.id) }}">{{ task.title }}</a></td>
        <td>
          <span class="badge" style="background-color: #{{ 'dc3545' if task.status == TaskStatusEnum.RE_ASSIGNED else '17a2b8' if 'REVIEW' in task.status.name else 'ffc107' if task.status == TaskStatusEnum.PAUSED else '28a745' if task.status == TaskStatusEnum.IN_PROGRESS else '007bff' }}; color: white;">
            {{ task.status.value.replace('_', ' ') }}
          </span>
        </td>
        <td>{{ task.deadline.astimezone(local_tz).strftime('%Y-%m-%d %H:%M') if task.deadline else 'Not set' }}</td>
        <td>{{ task.creator.full_name if task.creator else 'Unknown' }}</td>
        <td>
          {% if task.job %}
            <a href="{{ url_for('job.view_job', job_id=task.job.id) }}">{{ task.job.name }}</a>
          {% elif task.client %}
            {{ task.client.name }}
          {% else %}
            Internal
          {% endif %}
        </td>
        <td>
          <div class="dropdown">
            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" 
                    type="button" 
                    id="taskActions{{ task.id }}" 
                    data-bs-toggle="dropdown" 
                    aria-expanded="false">
              <i class="fas fa-chevron-down"></i> </button>
            
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="taskActions{{ task.id }}">
              
              <li>
                <a class="dropdown-item" href="{{ url_for('task.get_task', task_id=task.id) }}">
                  <i class="fas fa-eye me-2"></i> View Task
                </a>
              </li>
              
              <li>
                <button class="dropdown-item text-danger" 
                        onclick="showDeleteTaskModal('{{ task.id }}', '{{ task.title | e }}')">
                  <i class="fas fa-trash-alt me-2"></i> Delete Task
                </button>
              </li>

            </ul>
          </div>
        </td>
      </tr>
      {% else %}
      <tr>
        <td colspan="6" class="text-center text-muted">No tasks found in this category.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<nav aria-label="Page navigation" class="mt-3">
  <ul class="pagination">
    <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
      <a class="page-link" href="{{ url_for('task.get_assigned_tasks', user_id=target_user.id, tab=current_tab, page=pagination.prev_num) }}">&laquo; Previous</a>
    </li>
    {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
      {% if page_num %}
        <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
          <a class="page-link" href="{{ url_for('task.get_assigned_tasks', user_id=target_user.id, tab=current_tab, page=page_num) }}">{{ page_num }}</a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">...</span></li>
      {% endif %}
    {% endfor %}
    <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
      <a class="page-link" href="{{ url_for('task.get_assigned_tasks', user_id=target_user.id, tab=current_tab, page=pagination.next_num) }}">Next &raquo;</a>
    </li>
  </ul>
</nav>

<div class="modal fade" id="deleteTaskModal" tabindex="-1" aria-labelledby="deleteTaskModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteTaskModalLabel">Move Task to Trash</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to move the task titled: <strong><span id="taskTitlePlaceholder"></span></strong> to the trash?</p>
        <p class="text-danger">This will also soft-delete all associated notes, documents, and logs. You can recover it later if needed.</p>
        <input type="hidden" id="deleteTaskFormId" value="">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        
        <form id="deleteTaskForm" method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-danger">Yes, Move to Trash</button>
        </form>
      </div>
    </div>
  </div>
</div>

{% block scripts %}

<script>
    function showDeleteTaskModal(taskId, taskTitle) {
        // 1. Update the placeholder text with the task's title
        document.getElementById('taskTitlePlaceholder').innerText = taskTitle;
        
        // 2. Set the form action URL to the correct endpoint
        // NOTE: This assumes you have access to a global function like url_for 
        // or you need to pass the URL base in a data attribute.
        // If your base URL is simply '/task/', you can use:
        const deleteUrl = `/task/${taskId}/delete`; 
        

        document.getElementById('deleteTaskForm').action = deleteUrl;

        // 3. Show the Bootstrap modal
        // This requires Bootstrap 5's Modal constructor
        const deleteModal = new bootstrap.Modal(document.getElementById('deleteTaskModal'));
        deleteModal.show();
    }

    // Optional: Hide the modal after form submission (to prevent double-clicks/resubmissions)
    document.getElementById('deleteTaskForm').addEventListener('submit', function() {
        const modalElement = document.getElementById('deleteTaskModal');
        const modalInstance = bootstrap.Modal.getInstance(modalElement);
        if (modalInstance) {
            modalInstance.hide();
        }
    });
</script>

{% endblock%}
