{% extends 'base.html' %}
{% block head %}
    {{ super() }}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/npm/sweetalert2@11"></script> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.33/moment-timezone-with-data-10-year-range.min.js"></script> 
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">

    <style>
        .task-header{
            background: #fff;
        }


    </style>
{% endblock %}
{% block content %}
<div class="container bg-light p-4 rounded border">
    <div class="row">
        <div class="col-lg-8 border-end">
            <div class="col-lg-10 p-2 task-header">
                <div class="row">
                    <div class="col-lg-10">  
                        <h5> Tiittle:  {{ task.title }} </h5>
                    </div>
                    <div class="col-lg-10 mt-3"> 
                        <p>
                            Description: {{ task.description | default("No description provided for this task.", true) }}
                        </p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-lg-6">
                        <p>
                            Client: {% if task.client %}{{ task.client.name }}{% else %} 3A CPA LLP{% endif %}
                        </p>
                    </div>
                    <div class="col-lg-6">
                        <p>Service:  Task Service</p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-lg-6">
                        <p>Status: 
                            <span class="text-primary badge rounded-pill task-status-badge status-{{ task.status.name }}" id="taskStatusBadge">
                                {{ task.status.value }}
                            </span> 
                        </p>
                    </div>
                    <div class="col-lg-6">
                        <p class=""> Priority: <span class="rounded badge"> {{ task.priority }}</span> </p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-lg-6 p-2">
                        <p> 
                            Deadline:                         
                            {% if task.deadline %}
                            <span id="deadlineDisplay">{{ task.deadline.replace(tzinfo=pytz.utc).astimezone(local_tz).strftime('%Y-%m-%d %H:%M %Z') }}</span>
                            {% else %}
                                Not set
                            {% endif %} 
                        </p>
                    </div>
                    <div class="col-lg-6 p-2">
                        <p>created on</p>
                    </div> 
                </div>              
                <div class="row">
                    <div class="col-lg-6 p-2">
                        <p class="d-flex align-items-center">
                            Created by: &nbsp;
                            {% if task.creator %}
                                <span class="me-2">{{ task.creator.full_name }}</span>
                                {% if task.creator.profile_image_file and task.creator.profile_image_file|length > 25 %}
                                    <img src="{{ storage_service.get_file_url(task.creator.profile_image_file) }}" 
                                        alt="{{ task.creator.first_name }}"
                                        class="rounded-circle" width="24" height="24" style="object-fit: cover;"
                                        onerror="this.style.display='none'; document.getElementById('creator-init-{{ task.id }}').style.display='flex';">
                                    
                                    <div id="creator-init-{{ task.id }}" class="justify-content-center align-items-center rounded-circle bg-primary text-white" 
                                        style="width: 24px; height: 24px; font-size: 10px; font-weight: bold; display: none;">
                                        {{ task.creator.first_name[0]|upper }}{{ task.creator.last_name[0]|upper }}
                                    </div>
                                {% else %}
                                    <div class="d-inline-flex justify-content-center align-items-center rounded-circle bg-primary text-white" 
                                        style="width: 24px; height: 24px; font-size: 10px; font-weight: bold;">
                                        {{ task.creator.first_name[0]|upper }}{{ task.creator.last_name[0]|upper }}
                                    </div>
                                {% endif %}
                            {% else %}
                                <span class="text-muted">Unknown</span>
                            {% endif %}
                        </p>
                    </div>

                    <div class="col-lg-6">
                        <p class="d-flex align-items-center">
                            Assigned to: &nbsp;
                            {% if task.assignee %}
                                <a href="{{ url_for('task.get_assigned_tasks', user_id=task.assignee.id) }}" class="text-decoration-none text-primary me-2">
                                    {{ task.assignee.full_name }}
                                </a>
                                {% if task.assignee.profile_image_file and task.assignee.profile_image_file|length > 25 %}
                                    <img src="{{ storage_service.get_file_url(task.assignee.profile_image_file) }}" 
                                        alt="{{ task.assignee.first_name }}"
                                        class="rounded-circle" width="24" height="24" style="object-fit: cover;"
                                        onerror="this.style.display='none'; document.getElementById('assignee-init-{{ task.id }}').style.display='flex';">
                                    
                                    <div id="assignee-init-{{ task.id }}" class="justify-content-center align-items-center rounded-circle bg-primary text-white" 
                                        style="width: 24px; height: 24px; font-size: 10px; font-weight: bold; display: none;">
                                        {{ task.assignee.first_name[0]|upper }}{{ task.assignee.last_name[0]|upper }}
                                    </div>
                                {% else %}
                                    <div class="d-inline-flex justify-content-center align-items-center rounded-circle bg-primary text-white" 
                                        style="width: 24px; height: 24px; font-size: 10px; font-weight: bold;">
                                        {{ task.assignee.first_name[0]|upper }}{{ task.assignee.last_name[0]|upper }}
                                    </div>
                                {% endif %}
                            {% else %}
                                <span class="text-muted">Unassigned</span>
                            {% endif %}
                        </p>

                        {% set can_reassign = current_user.id == task.creator_id 
                      or task.assignee.id
                      or current_user.has_role('ADMIN') 
                      or current_user.has_role('DIRECTOR') 
                      or current_user.has_role('SUPERVISOR') %}

                    <p class="d-flex align-items-center mb-0">
                        <span class="me-1">Assigned to:</span>

                        <span id="assigneeName" class="d-flex align-items-center">
                            {% if task.assignee %}
                                <a href="{{ url_for('task.get_assigned_tasks', user_id=task.assignee.id) }}"
                                class="text-decoration-none text-primary me-2">
                                    {{ task.assignee.full_name }}
                                </a>

                                {% if task.assignee.profile_image_file and task.assignee.profile_image_file|length > 25 %}
                                    <img src="{{ storage_service.get_file_url(task.assignee.profile_image_file) }}"
                                        alt="{{ task.assignee.first_name }}"
                                        class="rounded-circle me-2"
                                        width="24"
                                        height="24"
                                        style="object-fit: cover;"
                                        onerror="
                                            this.style.display='none';
                                            document.getElementById('assignee-init-{{ task.id }}').style.display='flex';
                                        ">
                                    
                                    <div id="assignee-init-{{ task.id }}"
                                        class="justify-content-center align-items-center rounded-circle bg-primary text-white me-2"
                                        style="width:24px; height:24px; font-size:10px; font-weight:bold; display:none;">
                                        {{ task.assignee.first_name[0]|upper }}{{ task.assignee.last_name[0]|upper }}
                                    </div>
                                {% else %}
                                    <div class="d-inline-flex justify-content-center align-items-center rounded-circle bg-primary text-white me-2"
                                        style="width:24px; height:24px; font-size:10px; font-weight:bold;">
                                        {{ task.assignee.first_name[0]|upper }}{{ task.assignee.last_name[0]|upper }}
                                    </div>
                                {% endif %}
                            {% else %}
                                <span class="text-muted">Unassigned</span>
                            {% endif %}
                        </span>

                        {% if can_reassign %}
                            <button class="btn btn-sm btn-outline-secondary ms-2"
                                    data-bs-toggle="modal"
                                    data-bs-target="#reassignTaskModal"
                                    title="Change assignee">
                                <i class="fas fa-edit"></i>
                            </button>
                        {% endif %}
                    </p>

                    </div>
                </div>
            </div>

            {% if current_user.id == task.assignee.id %}
            <div class="card mb-4 shadow-sm task-actions-card" data-aos="fade-right" data-aos-delay="100">
                <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                    <p class="mb-0">Task Progress Actions</p>
                    <i class="fas fa-play-circle fa-lg"></i>
                </div>
                <div class="card-body p-1 m-2">
                    <button id="startButton" class="btn btn-success ">
                        <i class="fas fa-play-circle me-2"></i> Start Task
                    </button>

                    <button id="resumeButton" class="btn btn-info">

                        <i class="fas fa-redo me-2"></i> Resume Task

                    </button>

                    <button id="pauseButton" class="btn btn-warning text-dark">

                        <i class="fas fa-pause-circle me-2"></i> Pause Task

                    </button>

                    <button id="finishButton" class="btn btn-primary">

                        <i class="fas fa-check-circle me-2"></i> Complete Task

                    </button>

                </div>

            </div>
            {% else %}
            {% endif %}


            <p>Task Information</p>
            <!-- Tabs -->
             <div class="border-bottom">

                <ul class="nav nav-tabs" id="taskTabs" role="tablist" >

                    <li class="nav-item" role="presentation">

                        <a class="nav-link active" id="task-documents-tab" data-bs-toggle="tab" href="#task-documents" role="tab" aria-controls="task-documents" aria-selected="true"> <i class="fas fa-folder-open me-2"> </i> Task Documents </a>

                    </li>

                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="task-notes-tab" data-bs-toggle="tab" data-bs-target="#task-notes" type="button" role="tab" aria-controls="task-notes" aria-selected="false">
                            <i class="fas fa-sticky-note me-2"></i> Notes 
                            {% if task.notes|length > 0 %}
                                <span class="badge bg-danger ms-2">
                                    {{ task.notes|length }}
                                </span>
                            {% endif %}
                        </button>
                    </li>
                                {% if vat_form %}
                                                        <li class="nav-item" role="presentation">
                                                            <a class="nav-link" id="vat-form-tab" data-bs-toggle="tab" href="#vat-form" role="tab" aria-controls="vat-form" aria-selected="false">Vat Form</a>
                                                        </li>
                                {% endif %}

                </ul>

             </div>

            <!-- Tab Content -->

            <div class="tab-content mt-3" id="taskTabsContent">

                <div class="tab-pane fade show active" id="task-documents" role="tabpanel" aria-labelledby="task-documents-tab">
                    <div class="w-100 mt-3 p-2 border rounded">



                        <p class="mb-3 mt-3">Attached Documents</p>

                        <ul class="list-group list-group-flush mb-4">

                            {% for doc in task.documents %}

                                <li class="list-group-item d-flex justify-content-between align-items-center pe-0 ps-0 p-1">

                                    <div class="p-1">

                                    </br>

                                        <a href="{{ url_for('task.view_task_document', document_id=doc.id) }}" target="_blank" class="text-primary fw-bold">
                                            <i class="fas fa-file-alt me-2"></i> {{ doc.file_name }}
                                        </a>

                                        <small class="text-muted d-block mt-1">Uploaded by {{ doc.uploaded_by.full_name }} on {{ doc.uploaded_at.strftime('%d-%b-%Y') }}</small>

                                    </div>

                                    
                                                
                                    <a href="{{ url_for('task.download_file', file_path=doc.file_path) }}" 
                                    target="_blank" 
                                    class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-download"></i>
                                    </a>



                                    <form action="{{ url_for('task.delete_document', task_id=task.id, doc_id=doc.id) }}" method="POST" class="d-inline">
                                         <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                                        <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure you want to delete this document?');">

                                            <i class="fas fa-trash"></i>

                                        </button>

                                    </form>





                        

    

                                </li>

                            {% else %}

                                <li class="list-group-item text-muted">No documents uploaded yet.</li>

                            {% endfor %}

                        </ul>

    

                        <h6 class="mb-3"><i class="fas fa-upload me-2"></i>Upload a Document</h6>

                        <form action="{{ url_for('task.upload_document', task_id=task.id) }}" method="POST" enctype="multipart/form-data" class="mb-4 p-3 border rounded bg-light">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <div class="mb-3 col-lg-4">

                                <label for="document" class="form-label">Select Document File</label>

                                 <input type="file" name="document" id="document" class="form-control" required multiple>

                            </div>

                            <button type="submit" class="btn btn-primary"><i class="fas fa-cloud-upload-alt me-2"></i>Upload Document</button>

                           

                        </form>



                    </div>



                </div> 

                <div class="tab-pane fade p-2" id="task-notes" role="tabpanel" aria-labelledby="task-notes-tab">
                    <p class="mb-1">Task Notes and Comments </p>
                    
                    <div class="notes-container p-2" style="max-height: 500px; overflow-y: auto;">
                        
                        {% for note in task.notes|sort(attribute='created_at', reverse=false) %}
                            {# Determine if the note was created by the current user #}
                            {% set is_current_user = note.user.id == current_user.id %}
                            
                            <div class="row mb-3 gx-0">
                                {# Use offset and alignment for chat bubble effect #}
                                <div class="col-md-9 {% if is_current_user %} offset-md-3 {% endif %}">
                                    
                                
                                    <div class="card shadow-sm border-0 
                                        {% if is_current_user %} bg-primary text-white {% else %} bg-light text-dark {% endif %}">
                                        
                                        <div class="card-body p-3">
                                            
                                            <div class="d-flex {% if is_current_user %} justify-content-end {% else %} justify-content-start {% endif %} align-items-center mb-2">
                                                <div class="d-flex align-items-center {% if is_current_user %} flex-row-reverse {% endif %}">

                                                {% if note.user.profile_image_file and note.user.profile_image_file|length > 25 %}
                                                    <img src="{{ storage_service.get_file_url(note.user.profile_image_file) }}"
                                                        alt="{{ note.user.first_name }}"
                                                        class="rounded-circle {% if is_current_user %} ms-2 {% else %} me-2 {% endif %}" 
                                                        width="32" height="32">
                                                {% else %}
                                                    <div class="d-inline-flex justify-content-center align-items-center rounded-circle bg-primary text-white" 
                                                        style="width: 32px; height: 32px; font-size: 12px; font-weight: bold;">
                                                        {{ note.user.first_name[0]|upper }}{{ note.user.last_name[0]|upper }}
                                                    </div>
                                                {% endif %}

                                                    
                                                    {# FIX: Use text-white for current user's name on the primary background #}
                                                    <strong class="{% if is_current_user %} text-white {% else %} text-dark {% endif %}">
                                                        {{ note.user.full_name }}
                                                    </strong>
                                                </div>
                                            </div>
                                            
                                           
                                            <p class="mb-1 {% if is_current_user %} text-white {% else %} text-dark {% endif %}">
                                                {{ note.content }}
                                            </p>
                                            
                                            
                                            <small class="d-block {% if is_current_user %} text-end text-light {% else %} text-start text-muted {% endif %}">
                                                {{ note.created_at.replace(tzinfo=pytz.utc).astimezone(local_tz).strftime('%d %b %Y %I:%M %p') }}
                                            </small>


                                            <form action="{{ url_for('task.delete_note', task_id=task.id, note_id=note.id)}}" method="POST" class="d-inline">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure you want to delete this document?');">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <div class="text-center py-4">
                                <i class="fas fa-comment-dots fa-3x text-muted mb-3"></i>
                                <p class="text-muted">No notes yet. Be the first to add one!</p>
                            </div>
                        {% endfor %}
                        
                    </div>

                    <form action="{{ url_for('task.add_task_note', task_id=task.id) }}" method="POST" class="mb-1 p-2 border rounded bg-light">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="mb-3">
                            <label for="note_content" class="form-label">Add a New Note</label>
                            <textarea name="note_content" id="note_content" rows="1" class="form-control" placeholder="Write your note here..." required></textarea>
                        </div>
                        <button type="submit" class="btn btn-secondary w-50"><i class="fas fa-comment-dots me-2"></i>Post Note</button>
                    </form>
                </div>

                <div class="tab-pane fade col-lg-8 p-2" id="vat-form" role="tabpanel" aria-labelledby="vat-form-tab">

                    {% if vat_form %}
                            <button type="button" class="btn btn-info " 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#vatFormModal"
                                    {# CRITICAL FIX: Add 'task.job' or ensure 'job' is available and check it #}
                                    {% if job %} 
                                    data-vat-url="{{ url_for('job.view_vat_form_for_job', job_id=job.id, month=vat_form.month) }}"
                                    data-vat-save-url="{{ url_for('job.autosave_vat_form', job_id=job.id, month=vat_form.month) }}">
                                    {% endif %}
                                <i class="fas fa-file-invoice me-2"></i> Open VAT Form for {{ vat_form.month }}
                            </button>
                        {% endif %}

                </div>

                            <div class="modal fade" id="vatFormModal" tabindex="-1" aria-hidden="true">
                            <div class="modal-dialog modal-fullscreen">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">VAT Filing Form</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                <div class="modal-body" id="vatFormModalContent">
                                    <div class="text-center py-5">
                                    <div class="spinner-border text-primary" role="status"></div>
                                    </div>
                                </div>
                                </div>
                            </div>
                            </div>

            </div>
        </div>
        <div class="col-lg-4 bg-light">

            <div class=" rounded p-2 m-2">

                <p>Task Stats</p>

                <div class="border rounded row p-1 mb-2 mt-1">

                    <p>Task timer</p>

                    <p class="mb-0 fs-5">

                        {% if task.estimated_minutes %}

                            <span class="badge bg-info text-dark mb-2">

                                <i class="far fa-clock me-1"></i>

                                {% if task.estimated_minutes >= 1440 %}

                                    {{ (task.estimated_minutes // 1440) }} day(s)

                                {% elif task.estimated_minutes >= 60 %}

                                    {{ (task.estimated_minutes // 60) }} hour(s)

                                {% else %}

                                    {{ task.estimated_minutes }} minute(s)

                                {% endif %}

                            </span>

                        {% else %}

                            <span class="text-muted">No estimated time provided.</span>

                        {% endif %}





                    </p>

                </div>

                <div class="border rounded row p-1 mb-2 mt-1"> 

                    <p class="m-1"> <i class="fas fa-hourglass-half me-1"></i>  Task Progress</p>                      

                    {% if task.estimated_minutes and task.status not in [TaskStatusEnum.COMPLETED, TaskStatusEnum.REVIEW, TaskStatusEnum.MANAGER_REVIEW, TaskStatusEnum.PARTNER_REVIEW] %}

                        <div id="countdownTimer" class="fs-3 text-primary mb-2 p-2 border rounded bg-light text-center">

                        </div>

                    {% endif %}

                </div>

            </div>



            <div class="border rounded p-2 m-2">

                <p>Approval flow</p>

                {% if approvals %}

                    <ul class="list-group list-group-flush rounded">

                        {% for approval in approvals %}

                            <li class="list-group-item d-flex flex-column align-items-start py-3 {% if not loop.last %}border-bottom{% endif %}">

                                <div class="d-flex w-100 justify-content-between align-items-center mb-1">

                                    <strong>

                                    {% if approval.approver and approval.approver.profile_image_file and approval.approver.profile_image_file|length > 25 %}
                                        <img src="{{ storage_service.get_file_url(approval.approver.profile_image_file) }}"
                                            alt="{{ approval.approver.first_name }}"
                                            class="rounded-circle me-3" width="32" height="32">
                                    {% else %}
                                        <div class="d-inline-flex justify-content-center align-items-center rounded-circle bg-primary text-white"
                                            style="width: 32px; height: 32px; font-size: 12px; font-weight: bold;">
                                            {{ approval.approver.first_name[0]|upper }}{{ approval.approver.last_name[0]|upper }}
                                        </div>
                                    {% endif %}



                                        {{ approval.approver.full_name }}</strong>

                                        </br>

                                    {% if approval.decision.name == 'APPROVED' %}

                                        <span class="badge bg-success "><i class="fas fa-check-circle me-1"></i> Approved</span>

                                    {% elif approval.decision.name == 'REDO' %}

                                        <span class="badge bg-danger"><i class="fas fa-times-circle me-1"></i> Rejected</span>

                                    {% elif approval.decision.name == 'PENDING' %}

                                        <span class="badge bg-warning text-dark"><i class="fas fa-hourglass-half me-1"></i> Pending</span>

                                    {% endif %}

                                </div>

                                {% if approval.remarks %}

                                    <p> Remarks: <span  class="mb-0 mt-2 text-dark fst-italic">"{{ approval.remarks }}"  </span> </p>

                                {% endif %}

                            </li>

                        {% endfor %}

                    </ul>

                {% else %}

                    <p class="text-muted"><i class="fas fa-file-invoice-dollar me-2"></i>No approval  for this task.</p>

                {% endif %}





                {% if task.status in [TaskStatusEnum.REVIEW, TaskStatusEnum.MANAGER_REVIEW, TaskStatusEnum.PARTNER_REVIEW] %}

                <div class="card-footer">



                    {# This title will change depending on whose turn it is to review #}

                    <h6 class="mb-3 fw-bold">

                        {% if task.status == TaskStatusEnum.MANAGER_REVIEW %}

                            Manager's Review

                        {% elif task.status == TaskStatusEnum.PARTNER_REVIEW %}

                            Partner's Final Review

                        {% else  %}

                            Submit Your Review

                        {% endif %}

                    </h6>


                    <form id="approval-form" method="post" action="{{ url_for('task.review_task', task_id=task.id) }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="mb-3">
                            <label for="remarks" class="form-label">Remarks (optional)</label>
                            <textarea class="form-control" id="remarks" name="remarks" rows="3" placeholder="Write your review remarks here..."></textarea>
                        </div>
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button type="submit" name="decision" value="redo" class="btn btn-danger">
                                <i class="fas fa-redo me-1"></i> Reject
                            </button>
                            <button type="submit" name="decision" value="approved" class="btn btn-success">
                                <i class="fas fa-check-circle me-1"></i> Approve
                            </button>
                        </div>
                    </form>
                </div>
                {% endif %}

            </div>


            <div class="border rounded p-2 m-2">
                <p class="m-2">Task Logs (Activity Timeline) <i class="fas fa-history fa-lg"></i></p>
                {% if logs %}
                <div class="timeline-container" id="taskLogsContainer">
                    {% for log in logs | sort(attribute='start_time') %}
                        <div class="timeline-event py-3" data-aos="fade-up" data-aos-anchor-placement="top-bottom"> 
                            <div class=" {{ log.status.name }}"></div> {# Dynamic dot color #}
                            <p class="mb-1 fw-bold">
                                {% if log.status.name == 'STARTED' %}
                                    <i class="fas fa-play-circle text-success"></i> Started by {{ log.user.full_name }}
                                {% elif log.status.name == 'PAUSED' %}
                                    <i class="fas fa-pause-circle text-warning"></i> Paused by {{ log.user.full_name }}
                                {% elif log.status.name == 'COMPLETED' %}
                                    <i class="fas fa-check-circle text-primary"></i> Completed by {{ log.user.full_name }}
                                {% endif %}
                            </p>
                            <small class="text-muted d-block mb-1">
                                <i class="fas fa-calendar-alt me-1"></i> 
                                {{ log.start_time.replace(tzinfo=pytz.utc).astimezone(local_tz).strftime('%b %d, %Y %I:%M %p') }}
                            </small>
                            {% if log.end_time %}
                                <p class="mb-1">
                                    <small class="text-muted">
                                        <i class="fas fa-hourglass-end me-1"></i> Ended: {{ log.end_time.replace(tzinfo=pytz.utc).astimezone(local_tz).strftime('%b %d, %Y %I:%M %p') }}
                                    </small>
                                    {% set duration_minutes = (log.end_time - log.start_time).total_seconds() / 60 %}
                                    <span class="badge bg-secondary ms-2"><i class="fas fa-history me-1"></i> {{ duration_minutes | round(0) }} min duration</span>
                                </p>

                            {% endif %}
                            {% if log.notes %}
                                <p class="text-dark mt-2 fst-italic">"{{ log.notes }}"</p>
                            {% endif %}
                        </div>
                    {% endfor %}

                </div>

                {% else %}

                    <p class="text-muted" id="noLogsMessage"><i class="fas fa-box-open me-2"></i>No activity logs for this task yet.</p>

                {% endif %}

            </div>



        </div>
    </div>
</div>



<div class="modal fade" id="reassignTaskModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Reassign Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <div class="mb-3">
                    <label for="assigneeSelect" class="form-label">Assign to</label>
                    <select class="form-select" id="assigneeSelect">
                        {% for user in users %}
                            <option value="{{ user.id }}"
                                {% if task.assignee and user.id == task.assignee.id %}selected{% endif %}>
                                {{ user.full_name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Cancel
                </button>

                <button type="button"
                        class="btn btn-primary"
                        id="saveAssigneeBtn"
                        data-task-id="{{ task.id }}">
                    Save Changes
                </button>
            </div>

        </div>
    </div>
</div>




<script>

    document.addEventListener('DOMContentLoaded', function () {
        const taskId = "{{ task.id }}";
        // Ensure initialTaskStatus reflects the actual backend status names
        const initialTaskStatus = "{{ task.status.value }}";
        const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
        
        const startBtn = document.getElementById('startButton');
        const resumeBtn = document.getElementById('resumeButton');
        const pauseBtn = document.getElementById('pauseButton');
        const finishBtn = document.getElementById('finishButton');
        const taskStatusBadge = document.getElementById('taskStatusBadge'); // Reference the main status badge

        
        // --- Countdown Timer Variables ---
        const estimatedMinutes = {{ task.estimated_minutes | default(0) }};
        const initialTotalSeconds = estimatedMinutes * 60;
        const timerStorageKey = `taskTimer_${taskId}`; // Unique key for this task
        const countdownDisplay = document.getElementById('countdownTimer');
        const resetTimerBtn = document.getElementById('resetTimerBtn');
        
        let timerInterval = null;
        let remainingSeconds = initialTotalSeconds; // Default to full time
        // --- End Timer Variables ---

        // --- Countdown Timer Functions ---
        /** Formats a number of seconds into HH:MM:SS format */
        function formatTime(totalSeconds) {
            if (totalSeconds < 0) totalSeconds = 0;
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            
            return [hours, minutes, seconds]
                .map(v => String(v).padStart(2, '0')) // Ensures 01:05:09
                .join(':');
        }

        /** Updates the timer display element on the page */
        function updateTimerDisplay() {
            if (countdownDisplay) {
                countdownDisplay.textContent = formatTime(remainingSeconds);
            }
        }

        /** Saves the current remaining seconds to localStorage */
        function saveTimerState() {
            // We only need to save the remaining seconds.
            // The 'running' state is determined by the task status on page load.
            localStorage.setItem(timerStorageKey, remainingSeconds.toString());
            
            // Show reset button if timer has started
            if (resetTimerBtn && remainingSeconds < initialTotalSeconds && remainingSeconds > 0) {
                resetTimerBtn.style.display = 'inline-block';
            }
        }

        /** Loads the remaining seconds from localStorage */
        function loadTimerState() {
            const savedSeconds = localStorage.getItem(timerStorageKey);
            
            if (savedSeconds !== null) {
                remainingSeconds = parseInt(savedSeconds, 10);
                // If storage is corrupted, reset to full time
                if (isNaN(remainingSeconds)) {
                    remainingSeconds = initialTotalSeconds;
                }
            } else {
                // No saved state, use the initial full time
                remainingSeconds = initialTotalSeconds;
            }
            
            // Show reset button if timer is not at initial value
            if (resetTimerBtn && remainingSeconds < initialTotalSeconds && remainingSeconds > 0) {
                resetTimerBtn.style.display = 'inline-block';
            }
            
            updateTimerDisplay(); // Set initial display
        }

        /** Starts the countdown interval */
        function startCountdown() {
            if (timerInterval) return; // Prevents multiple intervals
            
            timerInterval = setInterval(() => {
                if (remainingSeconds > 0) {
                    remainingSeconds--;
                    updateTimerDisplay();
                    
                    // Save state every 10 seconds to reduce writes
                    if (remainingSeconds % 10 === 0) {
                        saveTimerState();
                    }
                } else {
                    pauseCountdown(); // Stop at 0
                    if (countdownDisplay) countdownDisplay.textContent = "Time's up!";
                    saveTimerState(); // Save the "0" state
                }
            }, 1000); // Ticks every second
        }

        /** Pauses the countdown interval and saves the state */
        function pauseCountdown() {
            clearInterval(timerInterval);
            timerInterval = null;
            // Always save state when pausing, if the timer exists
            if (estimatedMinutes > 0) {
                 saveTimerState();
            }
        }

        /** Resets the timer back to the full estimated time */
        function resetTimer() {
            pauseCountdown();
            remainingSeconds = initialTotalSeconds;
            localStorage.removeItem(timerStorageKey); // Clear saved state
            updateTimerDisplay();
            if(resetTimerBtn) resetTimerBtn.style.display = 'none';
        }
        
        // --- End Timer Functions ---

        // Initialize UI based on the current task status on page load
        updateUI(initialTaskStatus);

        // --- NEW TIMER INITIALIZATION LOGIC ---
        // Check if the timer elements exist on the page
        if (estimatedMinutes > 0 && countdownDisplay) {
            
            // 1. Load the timer's saved time from localStorage
            loadTimerState();

            // 2. Decide if the timer should be *ticking* based on the task's status
            const formattedStatus = initialTaskStatus.toUpperCase().replace(' ', '_');
            
            if (formattedStatus === 'IN_PROGRESS') {
                // If task is "In Progress", the timer should start ticking
                startCountdown();
            } else {
                // If task is "Paused", "Assigned", etc., it should be paused.
                // pauseCountdown() also saves the state.
                pauseCountdown(); 
            }
            
            // 3. Add listener for the reset button
            resetTimerBtn?.addEventListener('click', () => {
                Swal.fire({
                    title: 'Are you sure?',
                    text: "This will reset the timer to the full estimated time.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, reset it!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        resetTimer();
                        Swal.fire('Reset!', 'The timer has been reset.', 'success');
                    }
                })
            });
        }
        startBtn?.addEventListener('click', () => {
            console.log("Start button clicked");
            updateTaskStatus('start');
        });
        resumeBtn?.addEventListener('click', () => updateTaskStatus('resume'));
        pauseBtn?.addEventListener('click', () => updateTaskStatus('pause'));
        finishBtn?.addEventListener('click', () => updateTaskStatus('complete'));

        async function updateTaskStatus(action) {
            try {

                if (action === 'complete') {
                    localStorage.removeItem(timerStorageKey);
                }
                // Show a loading spinner or disable buttons to prevent double-clicks
                Swal.fire({
                    title: 'Updating Task...',
                    text: 'Please wait while we process your request.',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
                
                const response = await fetch(`/task/${taskId}/${action}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    }
                });

                const data = await response.json();
                if (response.ok) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: data.message,
                        showConfirmButton: false,
                        timer: 1500
                    }).then(() => {
                        // Update UI immediately and then reload for full data consistency
                        updateUI(data.task_status);
                        // Update the main status badge text and class
                        taskStatusBadge.textContent = data.task_status.replace('_', ' ');
                        taskStatusBadge.className = `badge rounded-pill task-status-badge status-${data.task_status.toUpperCase().replace(' ', '_')}`;
                        location.reload(); // Reload to fetch updated logs, etc.
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error!',
                        text: data.error || 'An unexpected error occurred.',
                        confirmButtonText: 'Ok'
                    });
                }
            } catch (err) {
                console.error("Fetch error:", err);
                Swal.fire({
                    icon: 'error',
                    title: 'Network Error!',
                    text: 'Could not connect to the server. Please try again.',
                    confirmButtonText: 'Ok'
                });
            }
        }

        // Function to update button visibility based on task status
        function updateUI(taskStatus) {
            startBtn.style.display = 'none';
            resumeBtn.style.display = 'none';
            pauseBtn.style.display = 'none';
            finishBtn.style.display = 'none';

            // Convert backend status string to a consistent format for comparison
            const formattedStatus = taskStatus.toUpperCase().replace(' ', '_');

            switch (formattedStatus) {
                case 'ASSIGNED':
                case 'RE_ASSIGNED':
                    startBtn.style.display = 'inline-block';
                    break;
                case 'IN_PROGRESS':
                    pauseBtn.style.display = 'inline-block';
                    finishBtn.style.display = 'inline-block';
                    break;
                case 'PAUSED':
                    resumeBtn.style.display = 'inline-block';
                    break;
                case 'COMPLETED':
                case 'REVIEW': // Assuming 'REVIEW' means 'Under Review' from backend
                case 'APPROVED':
                case 'REDO':
                    // All buttons remain hidden for final/review statuses
                    break;
                default:
                    // Fallback or specific logic for other statuses
                    break;
            }
        }

        // Deadline timer (if deadline is set)
        const deadlineDisplay = document.getElementById('deadlineDisplay');
        const timeRemainingDisplay = document.getElementById('timeRemainingDisplay');

        if (deadlineDisplay && timeRemainingDisplay) {
            const deadlineUtcStr = "{{ task.deadline | default('None') }}"; // Get UTC string from Jinja
            if (deadlineUtcStr !== 'None') {
                const deadlineMomentUtc = moment.utc(deadlineUtcStr); // Parse as UTC
                
                function updateTimer() {
                    const nowLocal = moment(); // Current time in local timezone
                    const deadlineLocal = deadlineMomentUtc.local(); // Convert deadline to local timezone for display

                    const diffMs = deadlineLocal.diff(nowLocal); // Difference in milliseconds

                    if (diffMs <= 0) {
                        timeRemainingDisplay.textContent = "Expired!";
                        timeRemainingDisplay.classList.add('text-danger'); // Highlight expired
                        clearInterval(timerInterval); // Stop the timer
                        return;
                    }

                    const duration = moment.duration(diffMs);
                    const days = Math.floor(duration.asDays());
                    const hours = duration.hours();
                    const minutes = duration.minutes();
                    const seconds = duration.seconds();

                    let timeString = '';
                    if (days > 0) {
                        timeString += `${days}d `;
                    }
                    timeString += `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                    
                    timeRemainingDisplay.textContent = timeString;

                    if (diffMs < 3600000) { // Less than 1 hour (3,600,000 ms)
                        timeRemainingDisplay.classList.add('text-warning');
                        timeRemainingDisplay.classList.remove('text-danger');
                    } else if (diffMs < 86400000) { // Less than 24 hours
                        timeRemainingDisplay.classList.remove('text-warning', 'text-danger');
                    }
                }

                updateTimer(); // Initial call
                const timerInterval = setInterval(updateTimer, 1000); // Update every second
            } else {
                timeRemainingDisplay.textContent = "N/A";
                timeRemainingDisplay.classList.add('text-muted');
            }
        }

        // ==============================
        // Reassign Task Logic  STEP 3
        // Send fetch, log everything
        // ==============================

        console.log('[Reassign STEP 3] Script section loaded');

        document.addEventListener('click', async function (e) {
            if (e.target && e.target.id === 'saveAssigneeBtn') {
                console.log('[Reassign STEP 3] Save button clicked');

                const taskId = e.target.dataset.taskId;
                const assigneeSelect = document.getElementById('assigneeSelect');
                const newUserId = assigneeSelect ? assigneeSelect.value : null;

                console.log('[Reassign STEP 3] taskId:', taskId);
                console.log('[Reassign STEP 3] newUserId:', newUserId);

                if (!taskId || !newUserId) {
                    Swal.fire('Error', 'Missing task or user ID', 'error');
                    return;
                }

                try {
                    console.log('[Reassign STEP 3] Sending fetch...');

                    const response = await fetch(`/task/${taskId}/assign`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({
                            user_id: newUserId
                        })
                    });

                    console.log('[Reassign STEP 3] HTTP status:', response.status);

                    const data = await response.json();
                    console.log('[Reassign STEP 3] Response JSON:', data);

                    Swal.fire({
                        icon: 'success',
                        title: 'Endpoint hit',
                        text: 'Check Flask terminal for logs'
                    });

                } catch (err) {
                    console.error('[Reassign STEP 3] Fetch error:', err);
                    Swal.fire('Error', err.message, 'error');
                }
            }
        });

    });

</script>


{% endblock %}